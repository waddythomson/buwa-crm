---
import { supabaseAdmin, supabase } from '../../lib/supabase';
import { createSession, findUserByEmail } from '../../lib/auth';

// Get the token from URL hash (Supabase sends it as fragment)
// Since fragment isn't sent to server, we handle this client-side
---

<html>
<head>
  <meta charset="UTF-8">
  <title>Signing in...</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e5e5;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error {
      color: #dc2626;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <p id="status">Signing you in...</p>
    <p id="error" class="error" style="display: none;"></p>
  </div>

  <script>
    async function handleCallback() {
      const status = document.getElementById('status');
      const error = document.getElementById('error');
      
      try {
        // Get hash params (Supabase sends tokens in URL fragment)
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        
        // Also check query params (some flows use these)
        const queryParams = new URLSearchParams(window.location.search);
        const tokenHash = queryParams.get('token_hash');
        const type = queryParams.get('type');
        
        if (accessToken && refreshToken) {
          // Exchange tokens for session
          const res = await fetch('/api/auth/exchange', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ accessToken, refreshToken })
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data.error || 'Failed to sign in');
          }
          
          // Redirect to dashboard
          window.location.href = '/';
        } else if (tokenHash && type === 'magiclink') {
          // Verify the magic link token
          const res = await fetch('/api/auth/verify-magic-link', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tokenHash, type })
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data.error || 'Failed to verify link');
          }
          
          window.location.href = '/';
        } else {
          throw new Error('Invalid login link. Please try again.');
        }
      } catch (err) {
        console.error('Callback error:', err);
        status.style.display = 'none';
        document.querySelector('.spinner').style.display = 'none';
        error.textContent = err.message || 'Something went wrong. Please try logging in again.';
        error.style.display = 'block';
        
        // Redirect to login after delay
        setTimeout(() => {
          window.location.href = '/login';
        }, 3000);
      }
    }
    
    handleCallback();
  </script>
</body>
</html>
