---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import { supabase } from '../lib/supabase';
import { getSession } from '../lib/auth';

const user = await getSession(Astro.cookies);
if (!user) return Astro.redirect('/login');

// Get recent contacts with last communication
const { data: contacts } = await supabase
  .from('contacts')
  .select('*, communications(created_at)')
  .order('created_at', { ascending: false })
  .limit(10);

// Get stats
const { count: contactCount } = await supabase.from('contacts').select('*', { count: 'exact', head: true });
const { count: commCount } = await supabase.from('communications').select('*', { count: 'exact', head: true });
---

<DashboardLayout title="Dashboard">
  <h1 style="margin-bottom: 24px;">Welcome, {user.name}!</h1>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <div class="card" style="text-align: center;">
      <div style="font-size: 36px; font-weight: 700; color: #2563eb;">{contactCount || 0}</div>
      <div style="color: #666;">Contacts</div>
    </div>
    <div class="card" style="text-align: center;">
      <div style="font-size: 36px; font-weight: 700; color: #10b981;">{commCount || 0}</div>
      <div style="color: #666;">Communications</div>
    </div>
  </div>

  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>Recent Contacts</h2>
      <a href="/contacts/new" class="btn">+ Add Contact</a>
    </div>
    
    {contacts && contacts.length > 0 ? (
      <div style="display: flex; flex-direction: column; gap: 12px;">
        {contacts.map(contact => (
          <a href={`/contacts/${contact.id}`} style="display: flex; justify-content: space-between; padding: 16px; background: #f9fafb; border-radius: 8px; text-decoration: none; color: inherit;">
            <div>
              <div style="font-weight: 600;">{contact.name}</div>
              <div style="color: #666; font-size: 14px;">{contact.phone || contact.email}</div>
            </div>
            <div style="color: #999; font-size: 14px;">
              {new Date(contact.created_at).toLocaleDateString()}
            </div>
          </a>
        ))}
      </div>
    ) : (
      <p style="color: #666; text-align: center; padding: 40px;">No contacts yet. Add your first contact!</p>
    )}
  </div>
</DashboardLayout>
